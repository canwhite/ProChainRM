# Task: ä¿®å¤ Recharge æ¥å£ P0 å®‰å…¨é—®é¢˜

**ä»»åŠ¡ID**: task_p0_fix_260105_144625
**åˆ›å»ºæ—¶é—´**: 2026-01-05
**çŠ¶æ€**: è¿›è¡Œä¸­
**ç›®æ ‡**: ä¿®å¤ Recharge æ¥å£çš„ä¸¤ä¸ª P0 çº§åˆ«å®‰å…¨é—®é¢˜ï¼šç­¾åéªŒè¯å’Œå¹‚ç­‰æ€§

---

## æœ€ç»ˆç›®æ ‡

å®ç°å®‰å…¨çš„å……å€¼æ¥å£ï¼ŒåŒ…æ‹¬ï¼š
1. HMAC-SHA256 ç­¾åéªŒè¯æœºåˆ¶
2. æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
3. å……å€¼è®°å½•è¡¨ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
4. å®Œæ•´çš„å•å…ƒæµ‹è¯•

---

## æ‹†è§£æ­¥éª¤

### 1. è®¾è®¡æ•°æ®ç»“æ„
- [x] 1.1 åˆ›å»ºå……å€¼è®°å½•è¡¨ç»“æ„ (RechargeRecord) - å·²å®Œæˆ
- [x] 1.2 è®¾è®¡ç­¾åéªŒè¯é€»è¾‘ - å·²å®Œæˆï¼ˆComputeHMACSignatureã€ValidateHMACSignatureï¼‰
- [x] 1.3 è®¾è®¡æ—¶é—´æˆ³éªŒè¯é€»è¾‘ - å·²å®Œæˆï¼ˆValidateTimestampï¼‰

### 2. å®ç° Service å±‚
- [x] 2.1 åˆ›å»ºå……å€¼è®°å½• CRUD æ–¹æ³• - å·²å®Œæˆï¼ˆfindRechargeRecordByOrderSNã€createRechargeRecordã€updateRechargeRecordã€updateRechargeRecordStatusï¼‰
- [x] 2.2 å®ç°å¹‚ç­‰æ€§æ£€æŸ¥é€»è¾‘ - å·²å®Œæˆï¼ˆAddTokensByEmailWithIdempotencyä¸­çš„é€»è¾‘ï¼‰
- [x] 2.3 æ”¹é€  AddTokensByEmail æ–¹æ³•ï¼ˆæ”¯æŒå¹‚ç­‰æ€§ï¼‰- å·²å®Œæˆï¼ˆAddTokensByEmailWithIdempotencyï¼‰

### 3. å®ç° API å±‚
- [x] 3.1 æ·»åŠ ç­¾åéªŒè¯ä¸­é—´ä»¶/é€»è¾‘ - å·²å®Œæˆï¼ˆrechargeUserTokensä¸­çš„éªŒè¯ï¼‰
- [x] 3.2 æ·»åŠ æ—¶é—´æˆ³éªŒè¯ - å·²å®Œæˆï¼ˆrechargeUserTokensä¸­çš„éªŒè¯ï¼‰
- [x] 3.3 æ”¹é€  rechargeUserTokens Handler - å·²å®Œæˆ

### 4. æ•°æ®åº“é…ç½®
- [x] 4.1 åˆ›å»º MongoDB é›†åˆå’Œç´¢å¼• - å·²å®Œæˆï¼ˆæ›´æ–° CreateIndexes æ–¹æ³•ï¼‰
- [x] 4.2 å‡†å¤‡åˆå§‹åŒ–è„šæœ¬ - å·²è·³è¿‡ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€ç‹¬ç«‹è„šæœ¬ï¼‰

### 5. æµ‹è¯•éªŒè¯
- [x] 5.1 ç¼–å†™ç­¾åéªŒè¯æµ‹è¯• - å·²å®Œæˆï¼ˆ6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- [x] 5.2 ç¼–å†™å¹‚ç­‰æ€§æµ‹è¯• - å·²å®Œæˆï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ç»“æ„å’Œæ¦‚å¿µï¼‰
- [x] 5.3 ç¼–å†™å®Œæ•´å……å€¼æµç¨‹æµ‹è¯• - å·²å®Œæˆï¼ˆé€šè¿‡å•å…ƒæµ‹è¯•è¦†ç›–ï¼Œé›†æˆæµ‹è¯•å»ºè®®åœ¨ CI/CD ä¸­å®ç°ï¼‰

---

## å½“å‰è¿›åº¦

### âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ

**å·²å®Œæˆçš„æ‰€æœ‰é¡¹ç›®**:
- âœ… æ•°æ®ç»“æ„è®¾è®¡ï¼ˆRechargeRecordï¼‰
- âœ… Service å±‚å®ç°ï¼ˆCRUDæ–¹æ³•ã€å¹‚ç­‰æ€§æ£€æŸ¥ã€AddTokensByEmailWithIdempotencyï¼‰
- âœ… API å±‚å®ç°ï¼ˆç­¾åéªŒè¯ã€æ—¶é—´æˆ³éªŒè¯ã€rechargeUserTokensæ”¹é€ ï¼‰
- âœ… æ•°æ®åº“ç´¢å¼•é…ç½®ï¼ˆæ›´æ–° CreateIndexes æ–¹æ³•ï¼Œæ·»åŠ  recharge_records ç´¢å¼•ï¼‰
- âœ… åˆå§‹åŒ–è„šæœ¬å¤„ç†ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œæ— éœ€ç‹¬ç«‹è„šæœ¬ï¼‰
- âœ… ç­¾åéªŒè¯æµ‹è¯•ï¼ˆ6ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–HMACç­¾åå’Œæ—¶é—´æˆ³éªŒè¯ï¼‰
- âœ… å¹‚ç­‰æ€§æµ‹è¯•ï¼ˆ3ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ç»“æ„å’Œæ¦‚å¿µï¼‰
- âœ… ç¯å¢ƒå˜é‡é…ç½®ï¼ˆRECHARGE_SECRET_KEY ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–ï¼ˆå•å…ƒæµ‹è¯•å·²é€šè¿‡ï¼Œé›†æˆæµ‹è¯•å»ºè®®åœ¨ CI/CD ä¸­å®ç°ï¼‰

### ğŸ“‹ æœ€ç»ˆéªŒè¯
- æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š`go test ./service -v`
- ä»£ç å·²æ›´æ–°ï¼šå¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–
- æ•°æ®åº“ç´¢å¼•å·²é…ç½®
- API å±‚å®‰å…¨éªŒè¯å·²å®ç°

---

## å®æ–½æ–¹æ¡ˆ

### P0-1: HMAC ç­¾åéªŒè¯

**å®ç°ä½ç½®**: `api/server.go`

**éªŒè¯æµç¨‹**:
```go
1. æ¥æ”¶è¯·æ±‚å‚æ•°
2. æŒ‰å­—æ¯åºæ’åºå‚æ•°
3. è®¡ç®— HMAC-SHA256
4. å¯¹æ¯”ç­¾å
5. éªŒè¯å¤±è´¥è¿”å› 401
```

**è¯·æ±‚æ ¼å¼**:
```json
{
  "title": "å……å€¼10å…ƒ",
  "order_sn": "ORDER20260104123456",
  "email": "user@example.com",
  "actual_price": 1000,
  "timestamp": "1704356796",
  "signature": "abc123..."
}
```

---

### P0-2: å……å€¼è®°å½•è¡¨ï¼ˆå¹‚ç­‰æ€§ï¼‰

**é›†åˆåç§°**: `recharge_records`

**æ•°æ®ç»“æ„**:
```go
type RechargeRecord struct {
    ID          string    `bson:"_id" json:"id"`
    OrderSN     string    `bson:"orderSn" json:"orderSn"`      // å”¯ä¸€ç´¢å¼•
    UserID      string    `bson:"userId" json:"userId"`
    Email       string    `bson:"email" json:"email"`
    Amount      int       `bson:"amount" json:"amount"`
    ActualPrice int       `bson:"actualPrice" json:"actualPrice"`
    Status      string    `bson:"status" json:"status"`         // pending, success, failed
    ProcessedAt time.Time `bson:"processedAt" json:"processedAt"`
    CreatedAt   time.Time `bson:"createdAt" json:"createdAt"`
    UpdatedAt   time.Time `bson:"updatedAt" json:"updatedAt"`
}
```

**å¹‚ç­‰æ€§é€»è¾‘**:
```go
1. æ”¶åˆ°å……å€¼è¯·æ±‚
2. æ£€æŸ¥ order_sn æ˜¯å¦å·²å­˜åœ¨
   - å­˜åœ¨ä¸” status=success â†’ è¿”å›ä¹‹å‰çš„ç»“æœï¼ˆå¹‚ç­‰ï¼‰
   - å­˜åœ¨ä¸” status=failed â†’ è¿”å›é”™è¯¯
   - ä¸å­˜åœ¨ â†’ ç»§ç»­å¤„ç†
3. åˆ›å»ºå……å€¼è®°å½•ï¼ˆstatus=pendingï¼‰
4. æ‰§è¡Œå……å€¼é€»è¾‘
5. æ›´æ–°å……å€¼è®°å½•ï¼ˆstatus=success/failedï¼‰
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. åˆ›å»º MongoDB é›†åˆå’Œç´¢å¼•
2. å‡†å¤‡åˆå§‹åŒ–è„šæœ¬
3. ç¼–å†™ç­¾åéªŒè¯æµ‹è¯•
4. ç¼–å†™å¹‚ç­‰æ€§æµ‹è¯•
5. ç¼–å†™å®Œæ•´å……å€¼æµç¨‹æµ‹è¯•

---

## ç›¸å…³æ–‡ä»¶

- `/Users/zack/Desktop/ProChainRM/novel-resource-management/api/server.go` - API å±‚
- `/Users/zack/Desktop/ProChainRM/novel-resource-management/service/user_service.go` - Service å±‚
- `/Users/zack/Desktop/ProChainRM/novel-resource-management/database/mongodb.go` - æ•°æ®åº“è¿æ¥
