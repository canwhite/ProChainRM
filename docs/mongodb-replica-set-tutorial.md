# MongoDB å‰¯æœ¬é›†é…ç½®å®Œå…¨æ•™ç¨‹

## å‡½æ•°ç›®æ ‡

`configureMongoDBReplicaSet` å‡½æ•°çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°† MongoDB ä»**å•æœºæ¨¡å¼**åˆ‡æ¢åˆ°**å›¢é˜Ÿåä½œæ¨¡å¼**ï¼ˆå‰¯æœ¬é›†æ¨¡å¼ï¼‰ã€‚

### é€šä¿—æ¯”å–»ï¼šå›¢é˜Ÿåä½œæ¨¡å¼

```
MongoDB çš„å·¥ä½œæ¨¡å¼ï¼š
1. å•æœºæ¨¡å¼ï¼ˆ1ä¸ªäººå·¥ä½œï¼‰ï¼šå¦‚æœè¿™ä¸ªäººè¯·å‡äº†ï¼ŒæœåŠ¡å°±åœäº†
2. å‰¯æœ¬é›†æ¨¡å¼ï¼ˆå¤šäººå›¢é˜Ÿï¼‰ï¼šä¸€ä¸ªäººè¯·å‡ï¼Œå…¶ä»–äººç»§ç»­å·¥ä½œ
```

è¿™ä¸ªå‡½æ•°å°±æ˜¯è¦æŠŠ MongoDB ä»**å•æœºæ¨¡å¼**åˆ‡æ¢åˆ°**å›¢é˜Ÿåä½œæ¨¡å¼**ã€‚

## å®Œæ•´æµç¨‹åˆ†è§£

### ç¬¬1æ­¥ï¼šå‡†å¤‡å·¥ä½œ
```go
// è·å–MongoDBè®¤è¯ä¿¡æ¯
mongoUser, mongoPass := getMongoConfig()
```
- ä»ç¯å¢ƒå˜é‡è¯»å–ç”¨æˆ·åå’Œå¯†ç 
- ç±»ä¼¼äºè·å–å›¢é˜Ÿç®¡ç†å‘˜çš„ç™»å½•å‡­è¯

### ç¬¬2æ­¥ï¼šè®¾ç½®è¶…æ—¶ä¿æŠ¤
```go
// è®¾ç½®10ç§’è¶…æ—¶
ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
defer cancel()
```
- ä¸ºæ‰€æœ‰æ•°æ®åº“æ“ä½œè®¾ç½®10ç§’è¶…æ—¶
- é˜²æ­¢æ•°æ®åº“æ“ä½œå¡æ­»æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹

### ç¬¬3æ­¥ï¼šå¯†ç ç¼–ç å¤„ç†
```go
// å¤„ç†å¯†ç ç¼–ç ï¼šå¦‚æœç¯å¢ƒå˜é‡ä¸­å·²ç»æ˜¯ç¼–ç è¿‡çš„ï¼Œå…ˆè§£ç å†é‡æ–°ç¼–ç 
var actualPassword string
if strings.Contains(mongoPass, "%40") {
    // å¦‚æœå¯†ç åŒ…å«%40ï¼Œå…ˆè§£ç å¾—åˆ°åŸå§‹å¯†ç 
    actualPassword = strings.ReplaceAll(mongoPass, "%40", "@")
} else {
    // å¦åˆ™ç›´æ¥ä½¿ç”¨
    actualPassword = mongoPass
}

// ç„¶åè¿›è¡Œæ­£ç¡®çš„URLç¼–ç 
encodedPassword := strings.ReplaceAll(actualPassword, "@", "%40")
```

**ä¸ºä»€ä¹ˆè¦å¤„ç†å¯†ç ç¼–ç ï¼Ÿ**

URLä¸­ç‰¹æ®Šå­—ç¬¦çš„ç¼–ç è§„åˆ™ï¼š
- `@` â†’ `%40`ï¼ˆåœ¨URLä¸­æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œéœ€è¦ç¼–ç ï¼‰
- æ¯”å¦‚å¯†ç æ˜¯ `admin@123`
- åœ¨URLä¸­å¿…é¡»å†™æˆ `admin%40123`

**å¤„ç†åœºæ™¯**ï¼š
1. ç¯å¢ƒå˜é‡ä¸­çš„å¯†ç å¯èƒ½å·²ç»ç¼–ç è¿‡äº†ï¼ˆ`admin%40123`ï¼‰
2. ä¹Ÿå¯èƒ½æ²¡ç¼–ç ï¼ˆ`admin@123`ï¼‰
3. æ‰€ä»¥éœ€è¦å…ˆåˆ¤æ–­ï¼Œå†æ­£ç¡®ç¼–ç 

### ç¬¬4æ­¥ï¼šæ„é€ è¿æ¥å­—ç¬¦ä¸²
```go
realMongoURI := fmt.Sprintf("mongodb://%s:%s@127.0.0.1:%s/%s?authSource=admin",
    mongoUser, encodedPassword, MongoPort, MongoDatabase)
```

**ç”Ÿæˆçš„è¿æ¥å­—ç¬¦ä¸²ç¤ºä¾‹**ï¼š
```
mongodb://admin:admin%40123@127.0.0.1:27017/admin?authSource=admin
```

**è§£é‡Šæ¯ä¸ªéƒ¨åˆ†**ï¼š
- `mongodb://`ï¼šåè®®æ ‡è¯†
- `admin`ï¼šç”¨æˆ·å
- `admin%40123`ï¼šç¼–ç åçš„å¯†ç ï¼ˆåŸå§‹å¯†ç æ˜¯ `admin@123`ï¼‰
- `127.0.0.1:27017`ï¼šæ•°æ®åº“åœ°å€å’Œç«¯å£
- `admin`ï¼šè¦è¿æ¥çš„æ•°æ®åº“å
- `authSource=admin`ï¼šè®¤è¯æ•°æ®åº“

### ç¬¬5æ­¥ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥
```go
checkCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval", "db.adminCommand('ping')")
if output, err := checkCmd.CombinedOutput(); err != nil {
    return fmt.Errorf("MongoDBè¿æ¥å¤±è´¥: %v, è¾“å‡º: %s", err, string(output))
}
fmt.Println("âœ… MongoDBè¿æ¥æˆåŠŸ")
```

**ç›¸å½“äº**ï¼š
```bash
mongosh "mongodb://admin:admin%40123@127.0.0.1:27017/admin" --eval "db.adminCommand('ping')"
```

**ç›®çš„**ï¼š
- ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸
- éªŒè¯ç”¨æˆ·åå¯†ç æ­£ç¡®
- ç¡®è®¤ç½‘ç»œé€šä¿¡æ­£å¸¸

### ç¬¬6æ­¥ï¼šæ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
```go
// æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
checkRSCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval",
    "try { rs.status().ok } catch(e) { 0 }")
output, err := checkRSCmd.CombinedOutput()
if err != nil {
    return fmt.Errorf("æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€å¤±è´¥: %v", err)
}

status := strings.TrimSpace(string(output))
```

**è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼Ÿ**
```javascript
try {
    rs.status().ok   // è·å–å‰¯æœ¬é›†çŠ¶æ€
} catch(e) {
    0  // å¦‚æœå‰¯æœ¬é›†æœªåˆå§‹åŒ–ï¼Œè¿”å› 0
}
```

**å¯èƒ½çš„ç»“æœ**ï¼š
- `"1"`ï¼šå‰¯æœ¬é›†å·²ç»é…ç½®
- `"0"`ï¼šå‰¯æœ¬é›†æœªé…ç½®ï¼Œéœ€è¦åˆå§‹åŒ–

### ç¬¬7æ­¥ï¼šå¤„ç†å·²é…ç½®çš„å‰¯æœ¬é›†
```go
if status == "1" {
    fmt.Println("âœ… å‰¯æœ¬é›†å·²é…ç½®ï¼Œæ£€æŸ¥IPé…ç½®...")

    // è·å–å½“å‰é…ç½®
    getConfigCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval", "rs.conf().members[0].host")
    output, err := getConfigCmd.CombinedOutput()
    if err != nil {
        return fmt.Errorf("è·å–å½“å‰å‰¯æœ¬é›†é…ç½®å¤±è´¥: %v", err)
    }

    currentHost := strings.TrimSpace(string(output))
    fmt.Printf("ğŸ“Š å½“å‰å‰¯æœ¬é›†é…ç½®: %s\n", currentHost)
```

**ç›¸å½“äº**ï¼š
```bash
mongosh "mongodb://..." --eval "rs.conf().members[0].host"
```

**å¯èƒ½è¿”å›**ï¼š
```
localhost:27017
# æˆ–è€…
172.16.181.101:27017
```

### ç¬¬8æ­¥ï¼šæ›´æ–°å‰¯æœ¬é›†é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
```go
// å¦‚æœé…ç½®ä¸æ­£ç¡®ï¼Œé‡æ–°é…ç½®
if !strings.Contains(currentHost, hostIP) {
    fmt.Println("ğŸ”§ æ›´æ–°å‰¯æœ¬é›†é…ç½®...")
    reconfigCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval",
        fmt.Sprintf(`rs.reconfig({_id: "rs0", members: [{_id: 0, host: "%s:%s"}]}, {force: true})`, hostIP, MongoPort))
    if output, err := reconfigCmd.CombinedOutput(); err != nil {
        return fmt.Errorf("æ›´æ–°å‰¯æœ¬é›†é…ç½®å¤±è´¥: %v, è¾“å‡º: %s", err, string(output))
    }
    fmt.Println("âœ… å‰¯æœ¬é›†é…ç½®å·²æ›´æ–°")
} else {
    fmt.Println("âœ… å‰¯æœ¬é›†é…ç½®å·²æ­£ç¡®")
}
```

**è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼Ÿ**
```javascript
rs.reconfig({
    _id: "rs0",                    // å‰¯æœ¬é›†åç§°
    members: [{
        _id: 0,                    // æˆå‘˜ID
        host: "172.16.181.101:27017"  // æ–°çš„æˆå‘˜åœ°å€
    }]
}, {force: true})                 // å¼ºåˆ¶é‡æ–°é…ç½®
```

**ä¸ºä»€ä¹ˆè¦æ›´æ–°ï¼Ÿ**
- å‰¯æœ¬é›†å¯èƒ½ä¹‹å‰é…ç½®ä¸º `localhost:27017`
- Docker å®¹å™¨æ— æ³•è®¿é—® `localhost`
- éœ€è¦æ”¹ä¸ºå®¿ä¸»æœºçš„çœŸå® IPï¼š`172.16.181.101:27017`

### ç¬¬9æ­¥ï¼šåˆå§‹åŒ–æ–°çš„å‰¯æœ¬é›†
```go
} else {
    fmt.Println("ğŸ”§ åˆå§‹åŒ–å‰¯æœ¬é›†...")
    initCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval",
        fmt.Sprintf(`rs.initiate({_id: "rs0", members: [{_id: 0, host: "%s:%s"}]})`, hostIP, MongoPort))
    if output, err := initCmd.CombinedOutput(); err != nil {
        return fmt.Errorf("åˆå§‹åŒ–å‰¯æœ¬é›†å¤±è´¥: %v, è¾“å‡º: %s", err, string(output))
    }
    fmt.Println("âœ… å‰¯æœ¬é›†åˆå§‹åŒ–æˆåŠŸ")

    // ç­‰å¾…å‰¯æœ¬é›†é€‰ä¸¾å®Œæˆ
    fmt.Println("â³ ç­‰å¾…å‰¯æœ¬é›†é€‰ä¸¾å®Œæˆ...")
    time.Sleep(10 * time.Second)
}
```

**è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼Ÿ**
```javascript
rs.initiate({
    _id: "rs0",                    // å‰¯æœ¬é›†åç§°
    members: [{
        _id: 0,                    // æˆå‘˜ID
        host: "172.16.181.101:27017"  // æˆå‘˜åœ°å€
    }]
})
```

**ä¸ºä»€ä¹ˆéœ€è¦ç­‰å¾…10ç§’ï¼Ÿ**
- å‰¯æœ¬é›†åˆå§‹åŒ–åéœ€è¦æ—¶é—´è¿›è¡Œé€‰ä¸¾
- é€‰æ‹© primary èŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹ï¼‰
- ç¡®ä¿å‰¯æœ¬é›†å®Œå…¨å°±ç»ª

### ç¬¬10æ­¥ï¼šéªŒè¯å‰¯æœ¬é›†çŠ¶æ€
```go
// éªŒè¯å‰¯æœ¬é›†çŠ¶æ€
fmt.Println("ğŸ” éªŒè¯å‰¯æœ¬é›†çŠ¶æ€...")
verifyCmd := exec.CommandContext(ctx, "mongosh", realMongoURI, "--eval",
    `rs.status().members.forEach(function(member) { print("- " + member.name + ": " + member.healthStr + " (" + member.stateStr + ")") })`)
verifyOutput, err := verifyCmd.CombinedOutput()
if err != nil {
    return fmt.Errorf("éªŒè¯å‰¯æœ¬é›†çŠ¶æ€å¤±è´¥: %v", err)
}
fmt.Printf("ğŸ“Š å‰¯æœ¬é›†çŠ¶æ€:\n%s", string(verifyOutput))
```

**è¿™ä¸ªå‘½ä»¤åšäº†ä»€ä¹ˆï¼Ÿ**
```javascript
rs.status().members.forEach(function(member) {
    print("- " + member.name + ": " + member.healthStr + " (" + member.stateStr + ")")
})
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸ“Š å‰¯æœ¬é›†çŠ¶æ€:
- 172.16.181.101:27017: 1 (PRIMARY)
```

## å®Œæ•´çš„æ‰§è¡Œæµç¨‹å›¾

```
å¼€å§‹é…ç½®å‰¯æœ¬é›†
    â†“
è·å–æ•°æ®åº“è®¤è¯ä¿¡æ¯
    â†“
è®¾ç½®10ç§’è¶…æ—¶ä¿æŠ¤
    â†“
å¤„ç†å¯†ç ç¼–ç ï¼ˆ@ â†’ %40ï¼‰
    â†“
æ„é€ è¿æ¥å­—ç¬¦ä¸²
    â†“
æ£€æŸ¥æ•°æ®åº“è¿æ¥ â† å¤±è´¥ â†’ è¿”å›é”™è¯¯
    â†“ æˆåŠŸ
æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
    â†“
â”Œâ”€ å¦‚æœå·²é…ç½® â”€â”
â”‚             â†“
â”‚  è·å–å½“å‰é…ç½®â”‚
â”‚             â†“
â”‚  æ£€æŸ¥IPæ˜¯å¦æ­£ç¡®â”‚
â”‚         â†™    â†˜
â”‚    æ­£ç¡®   é”™è¯¯
â”‚    â†“        â†“
â”‚  âœ… å®Œæˆ   é‡æ–°é…ç½®
â”‚             â†“
â”‚         âœ… æ›´æ–°å®Œæˆ
â”‚             â†“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ éªŒè¯çŠ¶æ€ â†â”€â”
                  â†“
â”Œâ”€ å¦‚æœæœªé…ç½® â”€â”     â”‚
â”‚             â†“     â”‚
â”‚  åˆå§‹åŒ–å‰¯æœ¬é›†     â”‚
â”‚             â†“     â”‚
â”‚  ç­‰å¾…10ç§’é€‰ä¸¾    â”‚
â”‚             â†“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ éªŒè¯çŠ¶æ€ â†â”€â”˜
                  â†“
              æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
                  â†“
              é…ç½®å®Œæˆ âœ…
```

## å®é™…ä¾‹å­æ¼”ç¤º

### åœºæ™¯1ï¼šé¦–æ¬¡éƒ¨ç½²ï¼ˆå‰¯æœ¬é›†æœªé…ç½®ï¼‰
```go
// ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œå‰¯æœ¬é›†æœªåˆå§‹åŒ–
configureMongoDBReplicaSet("172.16.181.101")

// æ‰§è¡Œæµç¨‹ï¼š
1. âœ… MongoDBè¿æ¥æˆåŠŸ
2. âš ï¸ å‰¯æœ¬é›†çŠ¶æ€è¿”å› "0"ï¼ˆæœªé…ç½®ï¼‰
3. ğŸ”§ åˆå§‹åŒ–å‰¯æœ¬é›†...
4. âœ… å‰¯æœ¬é›†åˆå§‹åŒ–æˆåŠŸ
5. â³ ç­‰å¾…å‰¯æœ¬é›†é€‰ä¸¾å®Œæˆ...
6. ğŸ” éªŒè¯å‰¯æœ¬é›†çŠ¶æ€...
7. ğŸ“Š å‰¯æœ¬é›†çŠ¶æ€:
   - 172.16.181.101:27017: 1 (PRIMARY)
8. âœ… é…ç½®å®Œæˆ
```

### åœºæ™¯2ï¼šé‡æ–°éƒ¨ç½²ï¼ˆå‰¯æœ¬é›†å·²é…ç½®ï¼ŒIPæ­£ç¡®ï¼‰
```go
// é‡æ–°è¿è¡Œï¼Œå‰¯æœ¬é›†å·²é…ç½®ä¸”IPæ­£ç¡®
configureMongoDBReplicaSet("172.16.181.101")

// æ‰§è¡Œæµç¨‹ï¼š
1. âœ… MongoDBè¿æ¥æˆåŠŸ
2. âœ… å‰¯æœ¬é›†çŠ¶æ€è¿”å› "1"ï¼ˆå·²é…ç½®ï¼‰
3. ğŸ“Š å½“å‰å‰¯æœ¬é›†é…ç½®: 172.16.181.101:27017
4. âœ… å‰¯æœ¬é›†é…ç½®å·²æ­£ç¡®
5. ğŸ” éªŒè¯å‰¯æœ¬é›†çŠ¶æ€...
6. ğŸ“Š å‰¯æœ¬é›†çŠ¶æ€:
   - 172.16.181.101:27017: 1 (PRIMARY)
7. âœ… é…ç½®å®Œæˆ
```

### åœºæ™¯3ï¼šIPåœ°å€å˜æ›´ï¼ˆéœ€è¦é‡æ–°é…ç½®ï¼‰
```go
// IPåœ°å€å˜åŒ–ï¼Œéœ€è¦æ›´æ–°é…ç½®
configureMongoDBReplicaSet("172.16.181.200")

// æ‰§è¡Œæµç¨‹ï¼š
1. âœ… MongoDBè¿æ¥æˆåŠŸ
2. âœ… å‰¯æœ¬é›†çŠ¶æ€è¿”å› "1"ï¼ˆå·²é…ç½®ï¼‰
3. ğŸ“Š å½“å‰å‰¯æœ¬é›†é…ç½®: 172.16.181.101:27017
4. âš ï¸ IPä¸åŒ¹é…ï¼Œéœ€è¦é‡æ–°é…ç½®
5. ğŸ”§ æ›´æ–°å‰¯æœ¬é›†é…ç½®...
6. âœ… å‰¯æœ¬é›†é…ç½®å·²æ›´æ–°
7. ğŸ” éªŒè¯å‰¯æœ¬é›†çŠ¶æ€...
8. ğŸ“Š å‰¯æœ¬é›†çŠ¶æ€:
   - 172.16.181.200:27017: 1 (PRIMARY)
9. âœ… é…ç½®å®Œæˆ
```

## ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·é…ç½®ï¼Ÿ

### 1. Docker ç½‘ç»œçš„ç‰¹æ®Šæ€§
```
MongoDB åœ¨å®¹å™¨å†…è¿è¡Œï¼š
- å®¹å™¨å†…åœ°å€ï¼šlocalhost:27017
- å®¹å™¨å¤–è®¿é—®ï¼š172.16.181.101:27017
```

### 2. å‰¯æœ¬é›†çš„ä¸¥æ ¼è¦æ±‚
- å‰¯æœ¬é›†é…ç½®çš„åœ°å€å¿…é¡»æ˜¯**å¤–éƒ¨å¯è®¿é—®**çš„åœ°å€
- ä¸èƒ½ä½¿ç”¨ `localhost`ï¼Œå› ä¸ºå…¶ä»–å®¹å™¨æ— æ³•è®¿é—®
- å¿…é¡»ä½¿ç”¨å®¿ä¸»æœºçš„çœŸå® IP

### 3. å®¹é”™æ€§
- å¦‚æœ IP åœ°å€å‘ç”Ÿå˜åŒ–ï¼Œå‰¯æœ¬é›†é…ç½®éœ€è¦æ›´æ–°
- è‡ªåŠ¨æ£€æµ‹é…ç½®ä¸åŒ¹é…å¹¶ä¿®å¤

## å‰¯æœ¬é›†å‘½ä»¤è¯¦è§£

### 1. rs.status() - æŸ¥çœ‹å‰¯æœ¬é›†çŠ¶æ€
```javascript
// å®Œæ•´çš„å‰¯æœ¬é›†çŠ¶æ€ä¿¡æ¯
rs.status()

// è·å–å‰¯æœ¬é›†æ˜¯å¦æ­£å¸¸
rs.status().ok  // è¿”å› 1 æˆ– 0

// è·å–æˆå‘˜ä¿¡æ¯
rs.status().members.forEach(function(member) {
    print("- " + member.name + ": " + member.healthStr + " (" + member.stateStr + ")")
})
```

### 2. rs.conf() - æŸ¥çœ‹å‰¯æœ¬é›†é…ç½®
```javascript
// å®Œæ•´çš„å‰¯æœ¬é›†é…ç½®
rs.conf()

// è·å–ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€
rs.conf().members[0].host

// é…ç½®ç»“æ„ç¤ºä¾‹
{
    "_id": "rs0",
    "members": [
        {
            "_id": 0,
            "host": "172.16.181.101:27017",
            "priority": 1,
            "votes": 1
        }
    ],
    "settings": {
        "chainingAllowed": true,
        "heartbeatIntervalMillis": 2000,
        "heartbeatTimeoutSecs": 10
    }
}
```

### 3. rs.initiate() - åˆå§‹åŒ–å‰¯æœ¬é›†
```javascript
// åŸºæœ¬åˆå§‹åŒ–
rs.initiate({
    _id: "rs0",
    members: [
        { _id: 0, host: "172.16.181.101:27017" }
    ]
})

// åŒ…å«æŠ•ç¥¨æƒçš„åˆå§‹åŒ–
rs.initiate({
    _id: "rs0",
    members: [
        { _id: 0, host: "172.16.181.101:27017", priority: 1, votes: 1 },
        { _id: 1, host: "172.16.181.102:27017", priority: 0.5, votes: 1 },
        { _id: 2, host: "172.16.181.103:27017", priority: 0, votes: 1 }
    ]
})
```

### 4. rs.reconfig() - é‡æ–°é…ç½®å‰¯æœ¬é›†
```javascript
// é‡æ–°é…ç½®æˆå‘˜åœ°å€
rs.reconfig({
    _id: "rs0",
    members: [
        { _id: 0, host: "172.16.181.101:27017" }
    ]
}, {force: true})

// æ·»åŠ æ–°æˆå‘˜
var config = rs.conf()
config.members.push({
    _id: 2,
    host: "172.16.181.103:27017",
    priority: 0,
    votes: 1
})
rs.reconfig(config)
```

## å‰¯æœ¬é›†çŠ¶æ€è¯´æ˜

### æˆå‘˜çŠ¶æ€ (stateStr)
- **PRIMARY**ï¼šä¸»èŠ‚ç‚¹ï¼Œå¯ä»¥å¤„ç†æ‰€æœ‰è¯»å†™æ“ä½œ
- **SECONDARY**ï¼šä»èŠ‚ç‚¹ï¼Œå¤åˆ¶æ•°æ®ï¼Œå¯ä»¥å¤„ç†è¯»æ“ä½œ
- **RECOVERING**ï¼šæ¢å¤ä¸­ï¼Œæš‚æ—¶ä¸å¯ç”¨
- **STARTUP**ï¼šå¯åŠ¨ä¸­
- **STARTUP2**ï¼šæ­£åœ¨åŒæ­¥æ•°æ®
- **ARBITER**ï¼šä»²è£è€…ï¼Œåªå‚ä¸é€‰ä¸¾ï¼Œä¸å­˜å‚¨æ•°æ®

### å¥åº·çŠ¶æ€ (healthStr)
- **1**ï¼šå¥åº·
- **0**ï¼šä¸å¥åº·

### é€‰ä¸¾ä¼˜å…ˆçº§ (priority)
- **1.0**ï¼šé«˜ä¼˜å…ˆçº§ï¼Œæ›´å®¹æ˜“æˆä¸ºä¸»èŠ‚ç‚¹
- **0.5**ï¼šä¸­ç­‰ä¼˜å…ˆçº§
- **0**ï¼šæ°¸è¿œä¸ä¼šæˆä¸ºä¸»èŠ‚ç‚¹

### æŠ•ç¥¨æƒ (votes)
- **1**ï¼šæœ‰æŠ•ç¥¨æƒï¼Œå‚ä¸é€‰ä¸¾
- **0**ï¼šæ— æŠ•ç¥¨æƒï¼Œä¸å‚ä¸é€‰ä¸¾

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ³•

### 1. è¿æ¥å¤±è´¥
```go
// é—®é¢˜ï¼šMongoDBè¿æ¥å¤±è´¥
// å¯èƒ½åŸå› ï¼š
// - MongoDB æœåŠ¡æœªå¯åŠ¨
// - ç«¯å£è¢«å ç”¨
// - ç½‘ç»œä¸é€š
// - è®¤è¯ä¿¡æ¯é”™è¯¯

// è§£å†³æ–¹æ³•ï¼š
// 1. æ£€æŸ¥ MongoDB æ˜¯å¦å¯åŠ¨
docker ps | grep mongo

// 2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 27017

// 3. æ£€æŸ¥è®¤è¯ä¿¡æ¯
mongosh "mongodb://user:pass@host:port/admin" --eval "db.adminCommand('ping')"
```

### 2. å‰¯æœ¬é›†åˆå§‹åŒ–å¤±è´¥
```go
// é—®é¢˜ï¼šrs.initiate() å¤±è´¥
// å¯èƒ½åŸå› ï¼š
// - å·²ç»åˆå§‹åŒ–è¿‡äº†
// - é…ç½®æ ¼å¼é”™è¯¯
// - åœ°å€ä¸å¯è®¿é—®

// è§£å†³æ–¹æ³•ï¼š
// 1. æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–
rs.status()

// 2. å¦‚æœéœ€è¦é‡æ–°åˆå§‹åŒ–ï¼Œå…ˆç§»é™¤é…ç½®
rs.reconfig({_id: "rs0", members: []}, {force: true})

// 3. ç„¶åé‡æ–°åˆå§‹åŒ–
rs.initiate({...})
```

### 3. IPåœ°å€å˜æ›´
```go
// é—®é¢˜ï¼šå®¹å™¨IPåœ°å€å˜åŒ–å¯¼è‡´å‰¯æœ¬é›†æ— æ³•è®¿é—®
// è§£å†³æ–¹æ³•ï¼šé‡æ–°é…ç½®å‰¯æœ¬é›†åœ°å€

// 1. è·å–å½“å‰é…ç½®
var config = rs.conf()

// 2. æ›´æ–°æˆå‘˜åœ°å€
config.members[0].host = "æ–°çš„IP:27017"

// 3. åº”ç”¨æ–°é…ç½®
rs.reconfig(config, {force: true})
```

### 4. è¶…æ—¶é—®é¢˜
```go
// é—®é¢˜ï¼šå‘½ä»¤æ‰§è¡Œè¶…æ—¶
// è§£å†³æ–¹æ³•ï¼š
// 1. å¢åŠ è¶…æ—¶æ—¶é—´
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)

// 2. æˆ–è€…åˆ†æ­¥éª¤æ‰§è¡Œï¼Œé€æ­¥éªŒè¯
// å…ˆæ£€æŸ¥è¿æ¥ï¼Œå†é…ç½®å‰¯æœ¬é›†
```

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. å‰¯æœ¬é›†é…ç½®æœ€ä½³å®è·µ
```javascript
// æ¨èçš„ç”Ÿäº§ç¯å¢ƒé…ç½®
rs.initiate({
    _id: "rs0",
    members: [
        // ä¸»èŠ‚ç‚¹
        {
            _id: 0,
            host: "172.16.181.101:27017",
            priority: 1,
            votes: 1
        },
        // ä»èŠ‚ç‚¹
        {
            _id: 1,
            host: "172.16.181.102:27017",
            priority: 0.5,
            votes: 1
        },
        // ä»²è£è€…ï¼ˆå¯é€‰ï¼‰
        {
            _id: 2,
            host: "172.16.181.103:27017",
            priority: 0,
            votes: 1,
            arbiterOnly: true
        }
    ]
})
```

### 2. ç›‘æ§å’Œå‘Šè­¦
```go
// å®šæœŸæ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
func checkReplicaSetHealth() error {
    // æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
    statusCmd := exec.CommandContext(ctx, "mongosh", uri, "--eval", "rs.status().ok")

    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸»èŠ‚ç‚¹
    primaryCmd := exec.CommandContext(ctx, "mongosh", uri, "--eval", "rs.isMaster().ismaster")

    // æ£€æŸ¥æˆå‘˜å¥åº·çŠ¶æ€
    healthCmd := exec.CommandContext(ctx, "mongosh", uri, "--eval", "rs.status().members")

    return nil
}
```

### 3. å¤‡ä»½ç­–ç•¥
```go
// åœ¨é…ç½®å‰¯æœ¬é›†æ—¶è€ƒè™‘å¤‡ä»½
func configureReplicaSetWithBackup() error {
    // é…ç½®å‰¯æœ¬é›†
    if err := configureMongoDBReplicaSet(hostIP); err != nil {
        return err
    }

    // ç­‰å¾…å‰¯æœ¬é›†ç¨³å®š
    time.Sleep(30 * time.Second)

    // æ‰§è¡Œå¤‡ä»½
    if err := createBackup(); err != nil {
        log.Printf("å¤‡ä»½å¤±è´¥: %v", err)
        // ä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼Œåªè®°å½•é”™è¯¯
    }

    return nil
}
```

## æ€»ç»“

è¿™ä¸ª `configureMongoDBReplicaSet` å‡½æ•°çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š

1. **å¥åº·æ£€æŸ¥**ï¼šç¡®ä¿ MongoDB è¿æ¥æ­£å¸¸
2. **æ™ºèƒ½é…ç½®**ï¼š
   - å¦‚æœæœªé…ç½® â†’ åˆå§‹åŒ–å‰¯æœ¬é›†
   - å¦‚æœå·²é…ç½®ä½†IPé”™è¯¯ â†’ é‡æ–°é…ç½®
   - å¦‚æœå·²é…ç½®ä¸”IPæ­£ç¡® â†’ è·³è¿‡é…ç½®
3. **å®¹é”™å¤„ç†**ï¼šå¤„ç†å„ç§ç¼–ç ã€ç½‘ç»œã€é…ç½®é—®é¢˜
4. **éªŒè¯ç¡®è®¤**ï¼šç¡®ä¿é…ç½®æˆåŠŸå¹¶æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€

è¿™æ˜¯ä¸€ä¸ªå¥å£®çš„ MongoDB å‰¯æœ¬é›†é…ç½®å‡½æ•°ï¼Œèƒ½å¤Ÿå¤„ç†å„ç§éƒ¨ç½²åœºæ™¯ï¼Œç‰¹åˆ«é€‚åˆ Docker å®¹å™¨åŒ–éƒ¨ç½²ç¯å¢ƒä¸­ä½¿ç”¨ï¼

é€šè¿‡ç†è§£è¿™ä¸ªå‡½æ•°çš„å·¥ä½œåŸç†ï¼Œä½ å¯ä»¥ï¼š
- æŒæ¡ MongoDB å‰¯æœ¬é›†çš„åŸºæœ¬æ¦‚å¿µ
- å­¦ä¼šä½¿ç”¨ mongosh å‘½ä»¤è¡Œå·¥å…·
- ç†è§£ Docker ç¯å¢ƒä¸‹çš„ç½‘ç»œé…ç½®
- æŒæ¡ Go è¯­è¨€ä¸­å¤–éƒ¨å‘½ä»¤æ‰§è¡Œçš„æœ€ä½³å®è·µ