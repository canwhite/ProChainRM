# RSAåŠ å¯†é—®é¢˜è§£å†³æ–‡æ¡£

## é—®é¢˜èƒŒæ™¯

åœ¨å®ç°Next.jså’ŒGoé¡¹ç›®ä¹‹é—´çš„RSAåŠ å¯†é€šä¿¡æ—¶ï¼Œé‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š
```
panic: runtime error: invalid memory address or nil pointer dereference
```

## é—®é¢˜è§£å†³è¿‡ç¨‹

### 1. åˆå§‹é—®é¢˜åˆ†æ
- é¡¹ç›®éœ€è¦å®ç°Next.jså’ŒGoä¹‹é—´çš„RSAåŠ å¯†é€šä¿¡
- æµ‹è¯•RSAåŠ å¯†åŠŸèƒ½æ—¶å‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸
- é”™è¯¯å‘ç”Ÿåœ¨ `utils/rsa.go` çš„ `Encrypt` æ–¹æ³•ä¸­

### 2. é”™è¯¯çš„è°ƒè¯•æ–¹å‘
ä¸€å¼€å§‹æˆ‘ä»¥ä¸ºæ˜¯ä»¥ä¸‹é—®é¢˜ï¼š
- å…¬é’¥æ–‡ä»¶æ ¼å¼é”™è¯¯
- å…¬é’¥è§£æå¤±è´¥
- å†…å­˜åˆå§‹åŒ–é—®é¢˜
- å¯†é’¥æ–‡ä»¶è·¯å¾„é—®é¢˜

### 3. çœŸæ­£çš„åŸå› å‘ç°
é€šè¿‡æ·±åº¦è°ƒè¯•ç¨‹åº `debug_rsa_deep.go`ï¼Œå‘ç°ï¼š
- **å…¬é’¥æœ¬èº«å®Œå…¨æ­£å¸¸**ï¼šPEMè§£ç æˆåŠŸï¼ŒPKIXè§£ææˆåŠŸï¼ŒNå’ŒEéƒ½æ­£ç¡®
- **é—®é¢˜å‡ºåœ¨å‡½æ•°è°ƒç”¨ä¸Š**ï¼š`rsa.EncryptOAEP(sha1.New(), nil, r.publicKey, []byte(data), nil)` ä¸­çš„ç¬¬äºŒä¸ªå‚æ•° `random` ä¼ å…¥äº† `nil`

### 4. æ ¹æœ¬åŸå› 
`rsa.EncryptOAEP` å‡½æ•°çš„ç­¾åï¼š
```go
func EncryptOAEP(hash hash.Hash, random io.Reader, pub *PublicKey, msg []byte, label []byte) ([]byte, error)
```

- ç¬¬äºŒä¸ªå‚æ•° `random` å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„éšæœºæ•°ç”Ÿæˆå™¨
- ä¼ å…¥ `nil` ä¼šå¯¼è‡´å‡½æ•°å†…éƒ¨å°è¯•è¯»å–ç©ºæŒ‡é’ˆï¼Œå¼•å‘å´©æºƒ
- å¿…é¡»ä½¿ç”¨ `crypto/rand.Reader` ä½œä¸ºéšæœºæ•°æº

## ä¸»è¦ä¿®æ”¹å†…å®¹

### ä¿®æ”¹æ–‡ä»¶ï¼š`utils/rsa.go`

**ä¿®æ”¹å‰ï¼š**
```go
// ä½¿ç”¨RSA-OAEPåŠ å¯†ï¼Œä½¿ç”¨SHA-1å“ˆå¸Œä¸Next.jsä¿æŒä¸€è‡´
encrypted, err := rsa.EncryptOAEP(sha1.New(), nil, r.publicKey, []byte(data), nil)
```

**ä¿®æ”¹åï¼š**
```go
// ä½¿ç”¨RSA-OAEPåŠ å¯†ï¼Œä½¿ç”¨SHA-1å“ˆå¸Œä¸Next.jsä¿æŒä¸€è‡´
// nil å‚æ•°ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå¿…é¡»ä½¿ç”¨ crypto/rand.Reader
encrypted, err := rsa.EncryptOAEP(sha1.New(), rand.Reader, r.publicKey, []byte(data), nil)
```

**æ·»åŠ çš„å¯¼å…¥ï¼š**
```go
import (
    "crypto/rand"  // æ–°å¢å¯¼å…¥
    "crypto/rsa"
    "crypto/sha1"
    "crypto/x509"
    "encoding/base64"
    "encoding/pem"
    "fmt"
    "log"
    "os"
)
```

## RSAåœ¨é¡¹ç›®ä¸­çš„ä½œç”¨

### 1. ç³»ç»Ÿæ¶æ„
```
Next.jsé¡¹ç›® [æœ‰å…¬é’¥]  <-- åŠ å¯†æ•°æ® -->  Goé¡¹ç›® [æœ‰ç§é’¥]
      ^                             |
      |                             |
      +-------- è§£å¯†æ•°æ® <----------+
```

### 2. å…³é”®ç»„ä»¶

#### A. RSAå¯†é’¥å¯¹
- **ç§é’¥**ï¼š`security/rsa_private_key.pem` - Goé¡¹ç›®æŒæœ‰ï¼Œç”¨äºè§£å¯†
- **å…¬é’¥**ï¼š`security/rsa_public_key.pem` - Next.jsé¡¹ç›®æŒæœ‰ï¼Œç”¨äºåŠ å¯†

#### B. RSAå·¥å…·ç±» (`utils/rsa.go`)
```go
type RSACrypto struct {
    privateKey *rsa.PrivateKey  // ç§é’¥ï¼Œç”¨äºè§£å¯†
    publicKey  *rsa.PublicKey   // å…¬é’¥ï¼Œç”¨äºåŠ å¯†
}
```

#### C. ä¸­é—´ä»¶ (`middleware/rsa.go`)
- æ£€æŸ¥è¯·æ±‚å¤´ `X-Encrypted-Request: true`
- å¦‚æœæ˜¯åŠ å¯†è¯·æ±‚ï¼Œè‡ªåŠ¨è§£å¯†æ•°æ®
- å°†è§£å¯†åçš„æ•°æ®ä¼ é€’ç»™ä¸šåŠ¡é€»è¾‘

### 3. å·¥ä½œæµç¨‹

#### åŠ å¯†è¿‡ç¨‹ï¼ˆNext.js â†’ Goï¼‰ï¼š
1. Next.jså°†æ•°æ®åºåˆ—åŒ–ä¸ºJSON
2. ä½¿ç”¨å…¬é’¥åŠ å¯†JSONæ•°æ®
3. å‘é€åŠ å¯†æ•°æ®åˆ°Goæ¥å£ï¼Œè¯·æ±‚å¤´åŒ…å« `X-Encrypted-Request: true`
4. Goä¸­é—´ä»¶æ£€æµ‹åˆ°åŠ å¯†è¯·æ±‚
5. ä½¿ç”¨ç§é’¥è§£å¯†æ•°æ®
6. å°†è§£å¯†åçš„æ•°æ®ä¼ ç»™ä¸šåŠ¡é€»è¾‘

#### åŠ è§£å¯†ä»£ç ï¼š
```go
// åŠ å¯†
encrypted, err := rsa.EncryptOAEP(sha1.New(), rand.Reader, publicKey, data, nil)

// è§£å¯†
decrypted, err := rsa.DecryptOAEP(sha1.New(), nil, privateKey, encryptedData, nil)
```

### 4. ä¸ºä»€ä¹ˆç”¨RSA-OAEP

#### OAEP (Optimal Asymmetric Encryption Padding) çš„ä¼˜ç‚¹ï¼š
- **å®‰å…¨æ€§é«˜**ï¼šæ¯”åŸå§‹çš„RSAåŠ å¯†æ›´å®‰å…¨
- **æŠ—æ”»å‡»**ï¼šå¯ä»¥æŠµæŠ—å·²çŸ¥çš„æ”»å‡»æ–¹å¼
- **æ ‡å‡†åŒ–**ï¼šå¹¿æ³›ä½¿ç”¨çš„åŠ å¯†æ ‡å‡†

#### ä¸ºä»€ä¹ˆç”¨SHA-1ï¼š
- ä¸ºäº†ä¸Next.jsé¡¹ç›®ä¿æŒä¸€è‡´
- ç¡®ä¿ä¸¤è¾¹çš„åŠ å¯†/è§£å¯†ç®—æ³•åŒ¹é…

### 5. å…³é”®è¦ç‚¹

1. **å¯†é’¥å®‰å…¨**ï¼šç§é’¥åªå­˜åœ¨äºGoé¡¹ç›®ï¼Œä¸ä¼šæš´éœ²ç»™å¤–éƒ¨
2. **é€æ˜æ€§**ï¼šä¸šåŠ¡ä»£ç ä¸éœ€è¦å…³å¿ƒåŠ å¯†/è§£å¯†ï¼Œä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†
3. **å…¼å®¹æ€§**ï¼šä½¿ç”¨æ ‡å‡†çš„RSA-OAEPç®—æ³•ï¼Œç¡®ä¿ä¸Next.jsçš„å…¼å®¹æ€§
4. **éšæœºæ€§**ï¼šåŠ å¯†æ—¶ä½¿ç”¨éšæœºæ•°ç”Ÿæˆå™¨ï¼Œç¡®ä¿åŒæ ·çš„æ˜æ–‡åŠ å¯†åç»“æœä¸åŒ

### 6. é€šä¿¡ç¤ºä¾‹

**Next.jså‘é€çš„åŠ å¯†è¯·æ±‚ï¼š**
```json
{
  "encryptedData": "FiMVKeKLQy26eWl6qm1L0uNozS+r1udHfF49KMyxQ8FEdpnB2Z..."
}
```

**Goä¸­é—´ä»¶è§£å¯†åçš„æ•°æ®ï¼š**
```json
{
  "userId": "test_rsa_user_001",
  "credit": 100,
  "totalUsed": 0,
  "totalRecharge": 100
}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•RSAå·¥å…·ç±»
```bash
go run debug_rsa_v2.go
```

### æµ‹è¯•å®Œæ•´åŠŸèƒ½ï¼ˆéœ€è¦å…ˆå¯åŠ¨æœåŠ¡å™¨ï¼‰
```bash
go run test_rsa_simple.go
```

## ç»éªŒæ€»ç»“

1. **ä¸è¦å¿½è§†å‡½æ•°å‚æ•°è¦æ±‚**ï¼šå³ä½¿æ˜¯çœ‹ä¼¼å¯é€‰çš„å‚æ•°ä¹Ÿè¦ä»”ç»†é˜…è¯»æ–‡æ¡£
2. **æ·±åº¦è°ƒè¯•å¾ˆé‡è¦**ï¼šæœ‰æ—¶å€™é—®é¢˜ä¸æ˜¯è¡¨é¢çœ‹åˆ°çš„é‚£ä¸ª
3. **ç†è§£å‡½æ•°ç­¾å**ï¼šæ¯ä¸ªå‚æ•°éƒ½æœ‰å…¶ç‰¹å®šçš„ä½œç”¨å’Œé™åˆ¶
4. **éšæœºæ•°åœ¨åŠ å¯†ä¸­çš„é‡è¦æ€§**ï¼šRSAåŠ å¯†éœ€è¦éšæœºæ•°æ¥ç¡®ä¿å®‰å…¨æ€§

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼ŒRSAåŠ å¯†é€šä¿¡ç³»ç»Ÿç°åœ¨å®Œå…¨æ­£å¸¸å·¥ä½œï¼ğŸ‰