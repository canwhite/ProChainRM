version: '3.8'

services:
  # MongoDBå‰¯æœ¬é›†è‡ªåŠ¨é…ç½®æœåŠ¡ï¼Œä½†æ˜¯è¿™é‡Œå› ä¸ºæ˜¯åœ¨dockerå®¹å™¨ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„æ˜¯ç¥å¥‡ç½‘å€
  # mongodb-config:
  #   image: alpine:latest
  #   container_name: novel-mongodb-config
  #   volumes:
  #     - ./scripts:/scripts:ro  # æŒ‚è½½è„šæœ¬ç›®å½•
  #   command: >
  #     sh -c "
  #       echo 'ğŸ”§ å¼€å§‹è‡ªåŠ¨é…ç½®å®¿ä¸»æœºMongoDBå‰¯æœ¬é›†...' &&
  #       # åœ¨å®¿ä¸»æœºä¸Šæ‰§è¡ŒMongoDBé…ç½®è„šæœ¬
  #       MONGO_ADMIN_USER='admin' MONGO_ADMIN_PASS='715705@Qc123' MONGO_PORT='27017' /scripts/config-host-mongodb.sh &&
  #       echo 'âœ… MongoDBå‰¯æœ¬é›†é…ç½®å®Œæˆ'
  #     "
  #   network_mode: host
  #   restart: "no"

  # Novel API æœåŠ¡
  novel-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: novel-api
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - MONGODB_URI=mongodb://admin:715705%40Qc123@host.docker.internal:27017/novel?replicaSet=rs0&authSource=admin
      - MONGODB_DATABASE=novel
      - MONGODB_TIMEOUT=30s
      - MONGODB_MAX_POOL_SIZE=10
      - MONGODB_MIN_POOL_SIZE=2
      - FABRIC_CERT_PATH=/app/test-network/organizations/peerOrganizations/org1.example.com
      - FABRIC_PEER_HOST=peer0.org1.example.com
      - FABRIC_PEER_PORT=7051
    ports:
      - "8080:8080"
    volumes:
      # æŒ‚è½½Fabricè¯ä¹¦æ–‡ä»¶
      - ../test-network:/app/test-network:ro
    extra_hosts:
      # å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºæœåŠ¡
      - "host.docker.internal:host-gateway"
    networks:
      # è‡ªåŠ¨è¿æ¥åˆ°ä¸¤ä¸ªç½‘ç»œ
      - novel-network
      - fabric_test
    # depends_on:
    #   mongodb-config:
    #     condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  # å†…éƒ¨ç½‘ç»œ
  novel-network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.200.0/24

  # å¤–éƒ¨Fabricç½‘ç»œï¼ˆéœ€è¦é¢„å…ˆå­˜åœ¨ï¼‰
  fabric_test:
    external: true